#summary The different ways of exporting metadata in JANUS

||<wiki:toc max_depth="3" />||

= Introduction =
JANUS supplies different ways of exporting metadata. On the entity level and on the federation level.

= Entity metadata export =
In the edit entity view, you can hit the Export tab and click the Export matadata link.

The page will display the metadata of the entity in SimpleSAMLphp flat file format. Links for displaying the metadata in SAML xml format and JSON is located in the buttom of the page.

The page have the following parameters

|| *Parameter* || *Value* || *Required* ||
|| eid || _int_ || Yes ||
|| revisionid || _int_ || Yes ||
|| output || 'xhtml' or not set || No ||

*NOTE* this page is protected, so only authorized users can access this page. This page should not be used for automatically export of metadata.

= Federation metadata export =
Federation metadata export can be done both dynamic or by pre-configuring the entities to be exported.

== Configuration ==
There are three configuration parameters related to metadata export. 

 * [MetadataExport111#Post_processors mdexport.postprocessor]
 * [MetadataExport111#Mime_types mdexport.allowed_mime]
 * [MetadataExport111#Default_options mdexport.default_options]

=== Options ===

The following is a quick overview of all allowed options used for exporting metadata. These options are used in both [MetadataExport111#Default_options mdexport.default_options] and [MetadataExport111#Feeds mdexport.feeds] options.

|| *Parameter* || *Value* ||
|| [MetadataExport111ConfigOptions#array__types types] || _array_ ||
|| [MetadataExport111ConfigOptions#array__states states] || _array_ ||
|| [MetadataExport111ConfigOptions#string__mime mime] || _string_ ||
|| [MetadataExport111ConfigOptions#array__exclude exclude] || _array_ ||
|| [MetadataExport111ConfigOptions#string__postprocessor postprocessor] || _string_ ||
|| [MetadataExport111ConfigOptions#string__entitiesDescriptorName entitiesDescriptorName] || _string_ ||
|| [MetadataExport111ConfigOptions#string__filename filename] || _string_ ||
|| [MetadataExport111ConfigOptions#int__maxCache maxCache] || _int_ ||
|| [MetadataExport111ConfigOptions#int__maxDuration maxDuration] || _int_ ||
|| [MetadataExport111ConfigOptions#boolean__sign.enable sign.enable] || _boolean_ ||
|| [MetadataExport111ConfigOptions#string__sign.privatekey sign.privatekey] || _string_ ||
|| [MetadataExport111ConfigOptions#string_-sign.privatekeye_pass sign.privatekey_pass] || _string_ ||
|| [MetadataExport111ConfigOptions#string__sign.certificate sign.certificate] || _string_ ||

=== Default options ===
The `mdexport.default_options` options array should contain default values for all metadata exports. These values can be overwritten in both dynamic mode and in preconfigured mode.

You should define default values for at least the following two options:

 * `entitiesDescriptorName`
 * `mime`

Example of a default configuration
{{{
'mdexport.default_options' => array(
    'entitiesDescriptorName' => 'Example Federation',
    'mime' => 'application/xml',
    'maxCache'      => 60*60*24, // 24 hour cache time
    'maxDuration'   => 60*60*24*5, // Maximum 5 days duration on ValidUntil.
    'sign.enable' => FALSE, // Don not sign metadata by default
),
}}}

A complete list of configuration options can be found [MetadataExport111ConfigOptions here].

=== Post processors ===
JANUS gives you the option to write your own custom post processor, that can modify the metadata further after the standard metadata have been generated.

==== Creating custom post processors ====
Creating a custom post processor is done by extending the class `sspmod_janus_Exporter`. The extending class  MUST be called sspmod_janus_Exporter_POSTPROCESSORNAME and MUST be placed in the file `JANUS-PATH/lib/Exporter/POSTPROCESSORNAME.php`

This class exposes two abstract methods which MUST be implemented.

 * `abstract protected function __construct(array $option = null);`
 * `abstract public function export($data);`

The `$option` is the options defined in the configuration for the post processor and the `$data` is the SAML xml metadata generated by JANUS.

*NOTE* it is up the post processor to output the metadata after the processing is done.

==== Configuring a post processor ====
Configuration the post processer is doen by defining an array in the `mdexport.postprocesssor` array with a unique key, post processor ID, for the post processor and containing the following three keys:

 * `class` - MUST be on the form `'janus:POSTPROCESSORNAME'`
 * `name` - A human readable name for the post processor
 * `option` - An array containing options for the post processor. There is no restrictions on the content of the `option` array

Example of post processor configuration:
{{{
'mdexport.postprocessor' => array(
    'filesystem' => array(
        'class' => 'janus:FileSystem',
        'name' => 'Filesystem',
        'option' => array(
            'path' => '/path/to/put/metadata.xml',
        ),
    ),
...
),
}}}
There is no restrictions on how many post processors that can be defined, as long af the appropriate classes are implemented.

=== Mime types ===
JANUS do by default support the following 3 mime types.

 * application/xml
 * application/samlmetadata+xml
 * application/simplesamlphp+text

Defining your own mime type does not change the actual exported metadata, only the `Content-Type` header. 

The returned metadata will always be SAML xml metadata except in the case where the mime type is set to `application/simplesamlphp+text` in which case the returned metadata is in simpleSAMLphp format.

== Dynamic metadata export ==
Export of federation metadata can be done dynamically in JANUS. Go to the Federation tab and hit the Federation export link.

You will be presented with a form allowing you to customize your metadata export. Values not filled in or not available via this form is fetched from the [MetadataExport111#Default_options mdexport.default_options] option.

This page can also be called directly by a browser or some other client capable of making a HTTP request. The following parameters are available.

|| *Parameter* || *Value* || *Required* ||
|| md || _void_ || Yes ||
|| type || _array(string)_ || Yes ||
|| state || _string_ || Yes ||
|| mime || _string_ || Yes ||
|| filename || _string_ || No ||
|| exclude || _string_ || No ||
|| postpro || _string_ || No ||
|| ignoreerrors || 'on' || No ||

It is highly recommended that you use a [MetadataExport111#Pre-configured_metadata_export pre-configured] metadata export feed if you plan to use JANUS directly as a metadata exchange source.

== Pre-configured metadata export ==
Pre-configuring a metadata export feed is the easiest way of distributing metadata. Configuring a metadata export feed is done by defining an entry in the `mdexport.feeds` option.

=== Configuring a feed ===
For configuring a feed you need to make an entry in the `mdexport.feeds` option. The key used is the Id used by external consumers to fetch the metadata, so be short and precise.

The metadata export feed can be fetched from

{{{
https://JANUS-URL/modules.php/janus/metadataexport.php
}}}

with the following parameters

|| *Parameter* || *Value* || *Required* ||
|| id || _string_ || Yes ||

`id` should be set to the ID defined for the metadata export feed.

The allowed options are the same as for the `mdexport.default_options` and can be found [MetadataExport111ConfigOptions here]. 

When generating the metadata the `mdexport.default_options`is merged with the configuration for the feed. If an option is supplied in both configurations, the the option defined in the feed configuration takes precedence.

Example of a feed configuration:

{{{
'mdexport.feeds' => array(
    'prod' => array(
        'types'                  => array('saml20-sp'),
        'states'                 => array('prod'),
        'mime'                   => 'application/samlmetadata+xml',
        'entitiesDescriptorName' => 'Sample Federation',
        'maxCache'               => 60*60*48, // 48 hour cache time
        'maxDuration'            => 60*60*24*5, // Maximum 5 days duration on ValidUntil.
        'sign.enable'            => TRUE,
        'sign.privatekey'        => 'sample_server.pem',
        'sign.privatekey_pass'   => 'VERY_SECRET_PASSWORD',
        'sign.certificate'       => 'sample_server.crt',
    ),
    ....
),
}}}

You can define as many feeds as you like.

*NOTE* metadata is not cached, so every request will result in hitting the database. You should therefor ensure caching by some other means, if you are planning to consume metadata heavily from  JANUS.